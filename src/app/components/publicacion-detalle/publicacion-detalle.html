<div class="body" #detalleArea>
  <app-side-nav></app-side-nav>

  <div class="detalle-container">

    <ng-container *ngIf="cargando || error; else detalleOk">
      <div class="estado-box">
        <p *ngIf="cargando">Cargando...</p>
        <p *ngIf="error">{{ error }}</p>
      </div>
    </ng-container>

    <ng-template #detalleOk>
      <div class="detalle-wrapper">

        <app-publicacion
          [publicacion]="publicacion"
          [usuarioActualId]="authService.getCurrentUser()?._id ?? null">
        </app-publicacion>

        <h3>Comentarios</h3>

        <div class="comentarios-lista">

          <div *ngFor="let comentario of comentarios" class="comentario-card">
            <div class="comentario-header">
              <img [src]="comentario.usuario.profileImage ?? 'https://i.pravatar.cc/48?img=65'" alt="avatar" class="avatar">
              <div class="usuario-info">
                <div class="usuario-nombre-fecha">
                  <strong>{{ comentario.usuario.username }}</strong>
                  <span class="fecha">{{ comentario.createdAt | date:'short' }}</span>
                  <span *ngIf="comentario.editado" class="editado">(editado)</span>
                </div>
              </div>

              <div class="menu-dots" *ngIf="esMioComentario(comentario)">
                <button class="dots-btn">â‹®</button>
                <div class="dropdown-menu">
                  <button (click)="abrirModalEditar(comentario)">âœï¸ Editar</button>
                </div>
              </div>
            </div>

            <p class="comentario-texto">{{ comentario.texto }}</p>

            <div class="comentario-footer">
              <button class="btn like-btn" [class.liked]="comentario.liked"
                      (click)="comentario.liked ? quitarLike(comentario) : darLike(comentario)">
                <span class="moon-icon">{{ comentario.liked ? 'ğŸŒ™' : 'ğŸŒ‘' }}</span>
                <span *ngIf="(comentario.likesCount ?? 0) > 0">{{ comentario.likesCount }}</span>
              </button>
            </div>
          </div>

          <div *ngIf="(comentarios?.length ?? 0) === 0 && !cargandoComentarios" class="sin-comentarios">
            ğŸŒ™âœ¨ No hay comentarios aÃºn. SÃ© el primero en comentar!
          </div>

          <button *ngIf="hasMore && !cargandoComentarios"
                  (click)="cargarMas()"
                  class="btn-cargar-mas">
            Cargar mÃ¡s
          </button>
          <p *ngIf="cargandoComentarios">Cargando...</p>
        </div>


        <div class="modal-overlay" *ngIf="editarComentarioSeleccionado">
          <div class="edit-modal">
            <h3>Editar comentario</h3>
            <textarea [(ngModel)]="comentarioEditadoTexto" rows="4"></textarea>
            <p class="contador-palabras">{{ palabrasComentarioEditado }}/{{ maxPalabras }} palabras</p>
            <div class="botones-modal">
              <button class="btn btn-guardar" (click)="guardarEdicion()">Guardar</button>
              <button class="btn btn-cancelar" (click)="cancelarEdicion()">Cancelar</button>
            </div>
          </div>
        </div>

      </div>
    </ng-template> 
  </div>

  <app-chat></app-chat>
</div>

<app-scroll-to-top [scrollTarget]="detalleArea"></app-scroll-to-top>