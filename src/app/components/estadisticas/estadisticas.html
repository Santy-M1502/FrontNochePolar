<div class="flex">
  <app-side-nav></app-side-nav>
<main class="dashboard-root" role="main">
  <header class="dashboard-header">
    <h1 class="title">Bienvenido {{ (user?.username || '') | capitalize }}</h1>
    <p class="subtitle" *ngIf="user?.perfil">Rol: {{ (user?.perfil || '') | capitalize }}</p>

    <div class="quick-actions" *appHasRole="'admin'">
      <div class="quick-date-buttons">
        <button type="button" (click)="rellenarUltimosDias(30)">√öltimos 30 d√≠as</button>
        <button type="button" (click)="rellenarUltimosDias(60)">√öltimos 60 d√≠as</button>
        <button type="button" (click)="rellenarUltimosDias(90)">√öltimos 90 d√≠as</button>
      </div>
    </div>
  </header>

  <section class="dashboard-grid" aria-label="Panel de estad√≠sticas">

    <article class="card" id="card-posts">
      <header class="card-header">
        <h2>Publicaciones por usuario</h2>
        <div class="card-controls">
          <input type="date" [(ngModel)]="desdePosts" placeholder="Desde">
          <input type="date" [(ngModel)]="hastaPosts" placeholder="Hasta">
          <button type="button" (click)="cargarPosts()">Cargar</button>
          <button type="button" (click)="toggleChartType('posts')">
            Tipo: {{ chartTypes['posts'] | capitalize }}
          </button>
        </div>
      </header>

      <div class="card-body">
        <canvas baseChart
                [data]="postsChartData"
                [labels]="postsChartLabels"
                [type]="chartTypes['posts']"
                [options]="chartOptions">
        </canvas>

        <ul class="summary-list">
          <li *ngFor="let p of postsByUser | slice:0:5">
            <button type="button" class="list-item-btn" (click)="abrirModalUsuario(p.userId, p.user)">
              {{ p.user | capitalize }} ‚Äî {{ p.count | humanNumber }}
            </button>
          </li>
        </ul>
      </div>
    </article>

    <article class="card" id="card-comments-time">
      <header class="card-header">
        <h2>Comentarios (por tiempo)</h2>
        <div class="card-controls">
          <input type="date" [(ngModel)]="desdeComments" placeholder="Desde">
          <input type="date" [(ngModel)]="hastaComments" placeholder="Hasta">
          <button type="button" (click)="cargarComentarios()">Cargar</button>
          <button type="button" (click)="toggleChartType('comments')">
            Tipo: {{ chartTypes['comments'] | capitalize }}
          </button>
        </div>
      </header>

      <div class="card-body">
        <canvas baseChart
                [data]="commentsChartData"
                [labels]="commentsChartLabels"
                [type]="chartTypes['comments']"
                [options]="chartOptions">
        </canvas>
      </div>
    </article>

    <article class="card" id="card-comments-per-post">
      <header class="card-header">
        <h2>Comentarios por publicaci√≥n</h2>
        <div class="card-controls">
          <input type="date" [(ngModel)]="desdeCommentsPerPost" placeholder="Desde">
          <input type="date" [(ngModel)]="hastaCommentsPerPost" placeholder="Hasta">
          <button type="button" (click)="cargarComentariosPorPost()">Cargar</button>
          <button type="button" (click)="toggleChartType('commentsPerPost')">
            Tipo: {{ chartTypes['commentsPerPost'] | capitalize }}
          </button>
        </div>
      </header>

      <div class="card-body">
        <canvas baseChart
                [data]="commentsPerPostChartData"
                [labels]="commentsPerPostChartLabels"
                [type]="chartTypes['commentsPerPost']"
                [options]="chartOptions">
        </canvas>

        <ol class="post-list">
          <li *ngFor="let p of commentsPerPost | slice:0:6">
            <button type="button" (click)="abrirModalPublicacion(p.id)" class="list-item-btn">
              {{ p.postTitle }}
            </button>
            <span class="count">({{ p.count }})</span>
          </li>
        </ol>
      </div>
    </article>

  </section>

  <footer class="dashboard-footer">
    <small>√öltima actualizaci√≥n: {{ now | relativeTime }}</small>
  </footer>
</main>

<div class="modal-overlay" *ngIf="modalVisible" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modalTitulo }}</h3>
      <button type="button" class="modal-close" (click)="cerrarModal()">‚úï</button>
    </div>

    <div class="modal-body" *ngIf="!cargandoModal">
      
      <div *ngIf="modalTipo === 'usuario' && modalContenido">
        <div class="modal-stats">
          <div class="stat-card">
            <span class="stat-label">Total publicaciones</span>
            <span class="stat-value">{{ modalContenido.length }}</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Total likes</span>
            <span class="stat-value">{{ getTotalLikes(modalContenido) }}</span>
          </div>
        </div>

        <div class="publicaciones-lista">
          <div class="publicacion-card" *ngFor="let pub of modalContenido">
            <h4>{{ pub.titulo || 'Sin t√≠tulo' }}</h4>
            <p class="pub-texto">{{ pub.texto }}</p>
            <img *ngIf="pub.imagenUrl" [src]="pub.imagenUrl" alt="Imagen" class="pub-imagen">
            <div class="pub-meta">
              <span>‚ù§Ô∏è {{ pub.likesCount || pub.likes?.length || 0 }}</span>
              <span>üí¨ {{ pub.comentarios?.length || 0 }}</span>
              <span>üìÖ {{ pub.createdAt | date:'short' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="modalTipo === 'publicacion' && modalContenido">
        <div class="publicacion-detalle">
          <div class="pub-info">
            <p class="pub-autor">Por: {{ modalContenido.publicacion.usuario?.username || 'Desconocido' }}</p>
            <p class="pub-fecha">{{ modalContenido.publicacion.createdAt | date:'medium' }}</p>
          </div>
          
          <div class="pub-contenido">
            <p>{{ modalContenido.publicacion.texto }}</p>
            <img *ngIf="modalContenido.publicacion.imagenUrl" 
                 [src]="modalContenido.publicacion.imagenUrl" 
                 alt="Imagen"
                 class="pub-imagen-grande">
          </div>

          <div class="modal-stats">
            <div class="stat-card">
              <span class="stat-label">‚ù§Ô∏è Likes</span>
              <span class="stat-value">{{ modalContenido.publicacion.likesCount || modalContenido.publicacion.likes?.length || 0 }}</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">üí¨ Comentarios</span>
              <span class="stat-value">{{ modalContenido.comentarios?.length || 0 }}</span>
            </div>
          </div>

          <div class="comentarios-section" *ngIf="modalContenido.comentarios?.length > 0">
            <h4>Comentarios</h4>
            <div class="comentario-item" *ngFor="let com of modalContenido.comentarios">
              <div class="comentario-header">
                <strong>{{ com.usuario?.username || 'An√≥nimo' }}</strong>
                <span class="comentario-fecha">{{ com.createdAt | date:'short' }}</span>
              </div>
              <p>{{ com.texto }}</p>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="modal-loading" *ngIf="cargandoModal">
      <p>Cargando...</p>
    </div>
  </div>
</div>

<div class="toast" *ngIf="toastVisible" [class.toast-success]="toastType === 'success'" 
     [class.toast-error]="toastType === 'error'" [class.toast-info]="toastType === 'info'">
  {{ toastMessage }}
</div>

<app-chat></app-chat>
</div>