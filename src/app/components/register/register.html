<div class="mm-outer">
  <div class="mm-tiles"></div>

  <div class="mm-stage">
    <header class="mm-header">
      <h1 class="mm-title">REGISTRO</h1>
      <p class="mm-sub">¡Crea tu cuenta y empieza a construir!</p>
    </header>

    <main class="mm-panel">
      <form [formGroup]="registerForm" (ngSubmit)="onSubmit()" class="mm-form" novalidate>

        <div class="form-section avatar-upload-wrap">
          <div class="avatar-ring">
            <div class="ring"></div>
            <img [src]="avatarPreview" alt="avatar" class="avatar" />
            <div class="orbit"></div>
            <div class="satellite"></div>
          </div>

          <button type="button" class="upload-btn" (click)="avatarInput.click()">Subir Foto</button>
          <input #avatarInput id="avatar" type="file" accept="image/*" (change)="onFileSelected($event)" hidden />

          <div class="mm-hint" *ngIf="fileError">
            <small class="error-text">{{ fileError }}</small>
          </div>
        </div>


        <div class="form-section">
          <div class="field">
            <input id="username" type="text" formControlName="username" placeholder="USUARIO"
                  [class.error]="controlInvalid('username')" />

            <div class="mm-hint" *ngIf="controlTouched('username')">
              <small *ngIf="registerForm.get('username')?.errors?.['required']">El usuario es requerido</small>
              <small *ngIf="registerForm.get('username')?.errors?.['minlength']">Mínimo 3 caracteres</small>
            </div>
          </div>
        </div>


        <div class="form-section two-cols">
          <div class="field">
            <input id="nombre" type="text" formControlName="nombre" placeholder="NOMBRE"
                  [class.error]="controlInvalid('nombre')" />
            <div class="mm-hint" *ngIf="controlTouched('nombre')">
              <small *ngIf="registerForm.get('nombre')?.errors?.['required']">El nombre es requerido</small>
              <small *ngIf="registerForm.get('nombre')?.errors?.['minlength']">Mínimo 3 caracteres</small>
            </div>
          </div>

          <div class="field">
            <input id="apellido" type="text" formControlName="apellido" placeholder="APELLIDO"
                  [class.error]="controlInvalid('apellido')" />
            <div class="mm-hint" *ngIf="controlTouched('apellido')">
              <small *ngIf="registerForm.get('apellido')?.errors?.['required']">El apellido es requerido</small>
              <small *ngIf="registerForm.get('apellido')?.errors?.['minlength']">Mínimo 3 caracteres</small>
            </div>
          </div>
        </div>


        <div class="form-section">
          <div class="field">
            <input id="email" type="email" formControlName="email" placeholder="EMAIL"
                  [class.error]="controlInvalid('email')" />
            <div class="mm-hint" *ngIf="controlTouched('email')">
              <small *ngIf="registerForm.get('email')?.errors?.['required']">El email es requerido</small>
              <small *ngIf="registerForm.get('email')?.errors?.['email']">Email inválido</small>
            </div>
          </div>
        </div>


        <div class="form-section">
          <div class="field">
            <input id="password" type="password" formControlName="password" placeholder="CONTRASEÑA"
                  [class.error]="controlInvalid('password')" />

            <div class="mm-hint" *ngIf="controlTouched('password')">
              <small *ngIf="controlInvalid('password')">Debe tener al menos 8 caracteres, una mayúscula y un número.</small>
            </div>
          </div>
        </div>


        <div class="form-section">
          <div class="field">
            <input id="confirmPassword" type="password" formControlName="confirmPassword" placeholder="CONFIRMAR CONTRASEÑA"
                  [class.error]="controlInvalid('confirmPassword') || (registerForm.errors?.['passwordMismatch'] && controlTouched('confirmPassword'))" />

            <div class="mm-hint" *ngIf="controlTouched('confirmPassword')">
              <small *ngIf="registerForm.get('confirmPassword')?.errors?.['required']">Debes confirmar la contraseña</small>
            </div>

            <div class="mm-hint" *ngIf="registerForm.errors?.['passwordMismatch'] && controlTouched('confirmPassword')">
              <small>Las contraseñas no coinciden</small>
            </div>
          </div>
        </div>


        <div class="form-section">
          <div class="field">
            <label for="fechaNacimiento" class="field-label">Fecha de Nacimiento (debe ser mayor de 13 años)</label>
            <input
              id="fechaNacimiento"
              type="date"
              formControlName="fechaNacimiento"
              [class.error]="controlInvalid('fechaNacimiento')"
            />

            <div class="mm-hint" *ngIf="controlTouched('fechaNacimiento')">
              <small *ngIf="registerForm.get('fechaNacimiento')?.errors?.['required']">
                La fecha es requerida
              </small>
              <small *ngIf="registerForm.get('fechaNacimiento')?.errors?.['edadInvalida']">
                Debes tener al menos 13 años
              </small>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="field">
            <textarea id="descripcion" rows="4" formControlName="descripcion" placeholder="DESCRIPCIÓN (opcional)"
                      maxlength="200" (input)="onDescripcionInput($event)"></textarea>

            <div class="mm-hint descripcion-row">
              <div *ngIf="controlTouched('descripcion') && registerForm.get('descripcion')?.errors">
                <small *ngIf="registerForm.get('descripcion')?.errors?.['maxlength']">Máx. 200 caracteres</small>
              </div>
              <small [class.warning]="descripcionCount === 200">{{ descripcionCount }}/200</small>
            </div>
          </div>
        </div>


        <div class="mm-messages">
          <div class="mm-success" *ngIf="successMessage">{{ successMessage }}</div>
          <div class="mm-error" *ngIf="errorMessage">{{ errorMessage }}</div>
        </div>


        <div class="mm-actions">
          <button type="submit" class="mm-btn mm-btn-primary" [disabled]="registerForm.invalid || isLoading">
            <span *ngIf="isLoading">Registrando...</span>
            <span *ngIf="!isLoading">REGISTRARSE</span>
          </button>

          <button type="button" class="mm-btn mm-btn-secondary" (click)="goToLogin()">YA TENGO CUENTA</button>
        </div>

      </form>
    </main>
  </div>
</div>
